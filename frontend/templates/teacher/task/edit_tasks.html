<html lang="ru">
<head>
    <link rel="stylesheet" href="/static/css/style.css">
    <style>
        .exam-info-box {
          background-color: #f8f9fa;
          border: 1px solid #ced4da;
          padding: 20px;
          border-radius: 10px;
          margin-bottom: 30px;
          box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
          max-width: 600px;
        }

        .exam-info-box h2 {
          margin-top: 0;
          color: #2c3e50;
        }

        #exam-details {
          font-size: 1rem;
          color: #333;
          line-height: 1.6;
        }
    </style>
    <meta charset="UTF-8">
    <title>–ó–∞–¥–∞–Ω–∏—è —ç–∫–∑–∞–º–µ–Ω–∞</title>
</head>
<body>

    <div id="exam-info" class="exam-info-box" style="margin-bottom: 20px;">
        <h2 id="exam-title">–ó–∞–≥—Ä—É–∑–∫–∞...</h2>
        <div id="exam-details"></div>
    </div>
    <h2 id="exam-title">–ó–∞–¥–∞–Ω–∏—è –¥–ª—è —ç–∫–∑–∞–º–µ–Ω–∞</h2>

    <div id="exam-info" style="margin-bottom: 20px;"></div>

    <div id="task-list"></div>

    <!-- –ö–Ω–æ–ø–∫–∏ –≤–Ω–∏–∑—É -->
    <div style="margin-top: 20px;">
        <button onclick="addTask()" id="add-task-btn">‚ûï –î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞–Ω–∏–µ</button>
        <button onclick="submitAllTasks()" id="save-all-btn" style="margin-left: 10px;" disabled>üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
    </div>

    <script>

        async function loadTasks(examId) {
            const response = await fetch(`/api/teacher/tasks/${examId}`, {
                method: "GET",
                headers: {
                    "Authorization": `Bearer ${localStorage.getItem('token')}`
                }
            });

            if (response.ok) {
                const tasks = await response.json();
                tasks.forEach((task, index) => {
                    addTask(task, index);  // –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –±–ª–æ–∫–∞ —Å –¥–∞–Ω–Ω—ã–º–∏
                });
            } else {
                console.warn("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∑–∞–¥–∞–Ω–∏—è. –í–æ–∑–º–æ–∂–Ω–æ, –∏—Ö –µ—â—ë –Ω–µ—Ç.");
            }
        }

        function loadOptions(index, options = [], correct_option = null) {
            for (let i = 0; i < options.length; i++) {
                addOption(index, options[i], i === correct_option);
            }
        }

        function addOption(index, value = null, isCorrect = false) {
            console.log(value);
            const optionFields = document.getElementById(`option-fields-${index}`);
            const correctSelect = document.getElementById(`correct_option_${index}`);
            const fieldCount = optionFields.querySelectorAll(".option-wrapper").length;

            const wrapper = document.createElement("div");
            wrapper.className = "option-wrapper";
            wrapper.style.display = "flex";
            wrapper.style.alignItems = "center";
            wrapper.style.marginBottom = "4px";

            const optIndex = optionFields.children.length;

            const numberLabel = document.createElement("span");
            numberLabel.innerText = `${fieldCount + 1}.`;
            numberLabel.style.marginRight = "5px";
            wrapper.appendChild(numberLabel);

            const input = document.createElement("input");
            input.type = "text";
            input.value = value ? value : "";
            input.placeholder = `–í–∞—Ä–∏–∞–Ω—Ç ${optIndex + 1}`;
            wrapper.appendChild(input);
            wrapper.appendChild(document.createElement("br"));

            const removeBtn = document.createElement("span");
            removeBtn.innerText = "‚ùå";
            removeBtn.style.cursor = "pointer";
            removeBtn.style.marginLeft = "8px";
            removeBtn.onclick = () => {
                wrapper.remove();
                correctSelect.querySelector(`option[value="${fieldCount}"]`)?.remove();
                reindexOptions(index);  // –ø–µ—Ä–µ—Å—á—ë—Ç –Ω–æ–º–µ—Ä–æ–≤
            };
            wrapper.appendChild(removeBtn);

            const option = document.createElement("option");
            option.value = optIndex;
            option.textContent = `–í–∞—Ä–∏–∞–Ω—Ç ${optIndex + 1}`;
            if (isCorrect) {
                option.selected = true;
            }

            optionFields.append(wrapper);
            correctSelect.appendChild(option);
        }

        function formatDateRange(start, end) {
            const options = {
                day: 'numeric',
                month: 'long',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            };

            const startDate = new Date(start).toLocaleString("ru-RU", options);
            const endDate = new Date(end).toLocaleString("ru-RU", options);
            return `${startDate} ‚Äì ${endDate}`;
        }

        const examId = window.location.pathname.split("/")[3];
        let taskIndex = 0;

        async function loadSubjectName(id) {
            const res = await fetch(`/api/admin/subjects/${id}`, {
                headers: { Authorization: `Bearer ${localStorage.getItem("token")}` }
            });
            const data = await res.json();
            return data.name;
        }

        async function loadGroupName(id) {
            const res = await fetch(`/api/admin/groups/${id}`, {
                headers: { Authorization: `Bearer ${localStorage.getItem("token")}` }
            });
            const data = await res.json();
            return data.name;
        }

        // JS ‚Äî –º–æ–∂–Ω–æ –≤—ã–∑–≤–∞—Ç—å –Ω–∞ window.onload –∏–ª–∏ –≤—Ä—É—á–Ω—É—é
        async function loadExamInfo(examId) {
            try {
                const res = await fetch(`/api/teacher/exams/${examId}`, {
                    headers: {
                        Authorization: `Bearer ${localStorage.getItem("token")}`,
                    },
                });

                if (!res.ok) throw new Error("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —ç–∫–∑–∞–º–µ–Ω: " + examId);

                const exam = await res.json();

                const subjectName = await loadSubjectName(exam.subject_id);
                const groupName = await loadGroupName(exam.group_id);
                const timeRange = formatDateRange(exam.start_time, exam.end_time);

                document.getElementById("exam-title").innerText = `–≠–∫–∑–∞–º–µ–Ω: ${exam.title}`;
                document.getElementById("exam-details").innerHTML = `
                    <li><strong>–û–ø–∏—Å–∞–Ω–∏–µ:</strong> ${exam.body}</li>
                    <li><strong>–ü—Ä–µ–¥–º–µ—Ç:</strong> ${subjectName}</li>
                    <li><strong>–ì—Ä—É–ø–ø–∞:</strong> ${groupName}</li>
                    <li><strong>–í—Ä–µ–º—è –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è:</strong> ${timeRange}</li>
                    <li><strong>–°—Ç–∞—Ç—É—Å:</strong> ${exam.status}</li>
                `;
            } catch (err) {
                console.error(err);
                document.getElementById("exam-title").innerText = "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —ç–∫–∑–∞–º–µ–Ω–∞";
            }
        }

        window.onload = async () => {
            const info = await fetch(`/api/teacher/exams/${examId}`, {
                headers: {
                    "Authorization": `Bearer ${localStorage.getItem('token')}`
                }
            });
            loadExamInfo(examId);
            loadTasks(examId);
        };

        function updateSaveAllButton() {
            const tasks = document.querySelectorAll(".task-block");
            const saveAllBtn = document.getElementById("save-all-btn");
            saveAllBtn.disabled = tasks.length === 0;
        }

        function addTask(task = null, index = null) {
            const taskList = document.getElementById("task-list");
            const taskBlock = document.createElement("div");
            taskBlock.className = "task-block";
            taskBlock.style.marginBottom = "30px";
            taskBlock.dataset.index = index ? index : taskIndex;

            const title = task ? task.title : "–ó–∞–¥–∞–Ω–∏–µ";
            const body = task ? task.body : "";
            const answer_type = task ? task.answer_type : "text";
            const options = task && task.options ? task.options : [];
            const correct_option = task ? task.correct_option : null;


            taskBlock.innerHTML = `
                    <input type="text" name="title_${taskIndex}" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è" value="${title}"><br><br>
                    <textarea name="body_${taskIndex}" placeholder="–¢–µ–∫—Å—Ç –∑–∞–¥–∞–Ω–∏—è" rows="4" style="width: 100%; resize: vertical;">${body}</textarea><br><br>

                    <label>–¢–∏–ø –æ—Ç–≤–µ—Ç–∞:</label>
                    <select name="answer_type_${taskIndex}" onchange="toggleOptions(this, ${taskIndex})">
                        <option value="text" ${answer_type === "text" ? "selected" : ""}>–¢–µ–∫—Å—Ç</option>
                        <option value="choice" ${answer_type === "choice" ? "selected" : ""}>–í—ã–±–æ—Ä</option>
                    </select><br><br>

                    <div class="options-block" id="options_${taskIndex}" style="display: ${answer_type === "choice" ? "block" : "none"}; margin-bottom: 10px;">
                        <div id="option-fields-${taskIndex}"></div>
                        <button onclick="addOption(${taskIndex})" type="button">–î–æ–±–∞–≤–∏—Ç—å –≤–∞—Ä–∏–∞–Ω—Ç</button><br><br>
                        <label for="correct_option_${taskIndex}">–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç:</label>
                        <select name="correct_option_${taskIndex}" id="correct_option_${taskIndex}"></select>
                    </div>

                    <button onclick="removeTask(this)" type="button" style="margin-left: 10px; color: red;">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
                    <hr>
                `;


            taskList.appendChild(taskBlock);

            if (answer_type === "choice") {
                // options.forEach((opt, i) => addOption(taskIndex, opt, i === correct_option));
                document.getElementById(`options_${taskIndex}`).style.display = "block";
                loadOptions(taskIndex, options, correct_option)
            }
            
            if (!task) taskIndex++;
            updateSaveAllButton();
        }

        function toggleOptions(select, index) {
            const block = document.getElementById(`options_${index}`);
            block.style.display = (select.value === 'choice') ? 'block' : 'none';
        }


        function reindexOptions(index) {
            const wrappers = document.querySelectorAll(`#option-fields-${index} .option-wrapper`);
            const correctSelect = document.getElementById(`correct_option_${index}`);
            correctSelect.innerHTML = "";
            wrappers.forEach((wrap, i) => {
                wrap.querySelector("span").innerText = `${i + 1}.`;
                wrap.querySelector("input").name = `option_${index}_${i}`;
                wrap.querySelector("input").placeholder = `–í–∞—Ä–∏–∞–Ω—Ç ${i + 1}`;
                const opt = document.createElement("option");
                opt.value = i;
                opt.innerText = `–í–∞—Ä–∏–∞–Ω—Ç ${i + 1}`;
                correctSelect.appendChild(opt);
            });
        }

        function removeTask(button) {
            const taskBlock = button.closest(".task-block");
            taskBlock.remove();
            updateSaveAllButton();
        }

        async function submitAllTasks() {
            const blocks = document.querySelectorAll(".task-block");
            const tasks = [];

            for (const block of blocks) {
                const index = block.dataset.index;

                const title = document.querySelector(`[name="title_${index}"]`).value;
                const body = document.querySelector(`[name="body_${index}"]`).value;
                const answer_type = document.querySelector(`[name="answer_type_${index}"]`).value;

                let task = { title, body, answer_type };

                if (answer_type === "choice") {
                    const options = Array.from(document.querySelectorAll(`#option-fields-${index} input`))
                                         .map(el => el.value)
                                         .filter(v => v.trim() !== "");  // –£–¥–∞–ª–∏–º –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏

                    const correct_option_raw = document.querySelector(`[name="correct_option_${index}"]`).value;
                    const correct_option = parseInt(correct_option_raw);

                    task.options = options;
                    task.correct_option = correct_option;
                }

                tasks.push(task);
            }

            if (tasks.length === 0) {
                alert("–î–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ –∑–∞–¥–∞–Ω–∏–µ.");
                return;
            }

            const response = await fetch(`/api/teacher/tasks/${examId}/create`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": `Bearer ${localStorage.getItem('token')}`
                },
                body: JSON.stringify({ tasks })  // ‚úÖ –ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –æ–±—ë—Ä—Ç–∫–∞
            });

            if (response.ok) {
                alert("–í—Å–µ –∑–∞–¥–∞–Ω–∏—è —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!");
            } else {
                const err = await response.json();
                alert("–û—à–∏–±–∫–∞: " + JSON.stringify(err));
            }
        }

    </script>

</body>
</html>
