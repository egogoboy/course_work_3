<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–¥–∞–Ω–∏–π</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <style>
        .exam-info-box {
            background-color: #f8f9fa;
            border: 1px solid #ced4da;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            max-width: 600px;
        }
    </style>
</head>
<body>

<div id="exam-info" class="exam-info-box">
    <h2 id="exam-title">–ó–∞–≥—Ä—É–∑–∫–∞...</h2>
    <div id="exam-details"></div>
</div>

<h2>–ó–∞–¥–∞–Ω–∏—è —ç–∫–∑–∞–º–µ–Ω–∞</h2>
<div id="task-list"></div>

<div style="margin-top: 20px;">
    <button onclick="addTask()" id="add-task-btn">‚ûï –î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞–Ω–∏–µ</button>
    <button onclick="submitAllTasks()" id="save-all-btn" style="margin-left: 10px;" disabled>üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
</div>

<script>
    const examId = window.location.pathname.split("/")[3];
    let taskIndex = 0;

    async function loadSubjectName(id) {
        const res = await fetch(`/api/admin/subjects/${id}`, {
            headers: { Authorization: `Bearer ${localStorage.getItem("token")}` }
        });
        const data = await res.json();
        return data.name;
    }

    async function loadGroupName(id) {
        const res = await fetch(`/api/admin/groups/${id}`, {
            headers: { Authorization: `Bearer ${localStorage.getItem("token")}` }
        });
        const data = await res.json();
        return data.name;
    }

    async function loadExamInfo(examId) {
        try {
            const res = await fetch(`/api/common/exams/${examId}`, {
                headers: {
                    Authorization: `Bearer ${localStorage.getItem("token")}`,
                },
            });
            if (!res.ok) throw new Error("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —ç–∫–∑–∞–º–µ–Ω");
            const exam = await res.json();
            const subjectName = await loadSubjectName(exam.subject_id);
            const groupName = await loadGroupName(exam.group_id);

            document.getElementById("exam-title").innerText = `–≠–∫–∑–∞–º–µ–Ω: ${exam.title}`;
            document.getElementById("exam-details").innerHTML = `
                <ul>
                    <li><strong>–û–ø–∏—Å–∞–Ω–∏–µ:</strong> ${exam.body}</li>
                    <li><strong>–ü—Ä–µ–¥–º–µ—Ç:</strong> ${subjectName}</li>
                    <li><strong>–ì—Ä—É–ø–ø–∞:</strong> ${groupName}</li>
                    <li><strong>–°—Ç–∞—Ç—É—Å:</strong> ${exam.status}</li>
                </ul>`;
        } catch (err) {
            console.error(err);
            document.getElementById("exam-title").innerText = "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —ç–∫–∑–∞–º–µ–Ω–∞";
        }
    }

    async function loadTasks() {
        const res = await fetch(`/api/teacher/tasks/${examId}`, {
            headers: {
                Authorization: `Bearer ${localStorage.getItem("token")}`
            }
        });
        const data = await res.json();

        for (const task of data) {
            addTask(task);
        }
    }

    function addTask(existing = null) {
        const index = taskIndex++;
        const taskList = document.getElementById("task-list");

        const taskBlock = document.createElement("div");
        taskBlock.className = "task-block";
        taskBlock.style.marginBottom = "30px";
        taskBlock.dataset.index = index;

        const answerType = existing?.answer_type || "text";
        const isChoice = answerType === "choice";

        taskBlock.innerHTML = `
            <input type="text" name="title_${index}" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è" value="${existing?.title || ''}"><br><br>
            <textarea name="body_${index}" placeholder="–¢–µ–∫—Å—Ç –∑–∞–¥–∞–Ω–∏—è" rows="4" style="width: 100%; resize: vertical;">${existing?.body || ''}</textarea><br><br>

            <label>–¢–∏–ø –æ—Ç–≤–µ—Ç–∞:</label>
            <select name="answer_type_${index}" onchange="toggleOptions(this, ${index})">
                <option value="text" ${!isChoice ? 'selected' : ''}>–¢–µ–∫—Å—Ç</option>
                <option value="choice" ${isChoice ? 'selected' : ''}>–í—ã–±–æ—Ä</option>
            </select><br><br>

            <div class="options-block" id="options_${index}" style="display: ${isChoice ? 'block' : 'none'}; margin-bottom: 10px;">
                <div id="option-fields-${index}"></div>
                <button onclick="addOption(${index})" type="button">–î–æ–±–∞–≤–∏—Ç—å –≤–∞—Ä–∏–∞–Ω—Ç</button><br><br>
                <label>–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç:</label>
                <select name="correct_option_${index}" id="correct_option_${index}"></select>
            </div>

            <button onclick="removeTask(this)" type="button" style="color: red;">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
            <hr>
        `;

        taskList.appendChild(taskBlock);

        // –ó–∞–ø–æ–ª–Ω–∏—Ç—å –≤–∞—Ä–∏–∞–Ω—Ç—ã, –µ—Å–ª–∏ —Ç–∏–ø –≤—ã–±–æ—Ä–∞
        if (isChoice && existing?.options) {
            for (let i = 0; i < existing.options.length; i++) {
                addOption(index, existing.options[i]);
            }
            document.getElementById(`correct_option_${index}`).value = existing.correct_option;
        }

        updateSaveAllButton();
    }

    function toggleOptions(select, index) {
        const block = document.getElementById(`options_${index}`);
        block.style.display = (select.value === 'choice') ? 'block' : 'none';
    }

    function addOption(index, value = "") {
        const container = document.getElementById(`option-fields-${index}`);
        const correctSelect = document.getElementById(`correct_option_${index}`);
        const fieldCount = container.querySelectorAll(".option-wrapper").length;

        const wrapper = document.createElement("div");
        wrapper.className = "option-wrapper";
        wrapper.style.display = "flex";
        wrapper.style.alignItems = "center";
        wrapper.style.marginBottom = "4px";

        const numberLabel = document.createElement("span");
        numberLabel.innerText = `${fieldCount + 1}.`;
        numberLabel.style.marginRight = "5px";
        wrapper.appendChild(numberLabel);

        const input = document.createElement("input");
        input.name = `option_${index}_${fieldCount}`;
        input.placeholder = `–í–∞—Ä–∏–∞–Ω—Ç ${fieldCount + 1}`;
        input.value = value;
        input.style.flex = "1";
        wrapper.appendChild(input);

        const removeBtn = document.createElement("span");
        removeBtn.innerText = "‚ùå";
        removeBtn.style.cursor = "pointer";
        removeBtn.style.marginLeft = "8px";
        removeBtn.onclick = () => {
            wrapper.remove();
            reindexOptions(index);
        };
        wrapper.appendChild(removeBtn);

        container.appendChild(wrapper);

        const option = document.createElement("option");
        option.value = fieldCount;
        option.innerText = `–í–∞—Ä–∏–∞–Ω—Ç ${fieldCount + 1}`;
        correctSelect.appendChild(option);
    }

    function reindexOptions(index) {
        const wrappers = document.querySelectorAll(`#option-fields-${index} .option-wrapper`);
        const correctSelect = document.getElementById(`correct_option_${index}`);
        correctSelect.innerHTML = "";
        wrappers.forEach((wrap, i) => {
            wrap.querySelector("span").innerText = `${i + 1}.`;
            wrap.querySelector("input").name = `option_${index}_${i}`;
            wrap.querySelector("input").placeholder = `–í–∞—Ä–∏–∞–Ω—Ç ${i + 1}`;
            const opt = document.createElement("option");
            opt.value = i;
            opt.innerText = `–í–∞—Ä–∏–∞–Ω—Ç ${i + 1}`;
            correctSelect.appendChild(opt);
        });
    }

    function removeTask(button) {
        const taskBlock = button.closest(".task-block");
        taskBlock.remove();
        updateSaveAllButton();
    }

    function updateSaveAllButton() {
        const tasks = document.querySelectorAll(".task-block");
        document.getElementById("save-all-btn").disabled = tasks.length === 0;
    }

    async function submitAllTasks() {
        const blocks = document.querySelectorAll(".task-block");
        const tasks = [];

        for (const block of blocks) {
            const index = block.dataset.index;
            const title = document.querySelector(`[name="title_${index}"]`).value;
            const body = document.querySelector(`[name="body_${index}"]`).value;
            const answer_type = document.querySelector(`[name="answer_type_${index}"]`).value;

            let task = { title, body, answer_type };

            if (answer_type === "choice") {
                const options = Array.from(document.querySelectorAll(`#option-fields-${index} input`))
                    .map(el => el.value.trim()).filter(Boolean);
                const correct_option = parseInt(document.getElementById(`correct_option_${index}`).value);
                task.options = options;
                task.correct_option = correct_option;
            }

            tasks.push(task);
        }

        const response = await fetch(`/api/teacher/tasks/${examId}`, {
            method: "PUT",
            headers: {
                "Content-Type": "application/json",
                "Authorization": `Bearer ${localStorage.getItem("token")}`
            },
            body: JSON.stringify({ tasks })
        });

        if (response.ok) {
            alert("–ó–∞–¥–∞–Ω–∏—è —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω—ã!");
            location.reload();
        } else {
            alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –∑–∞–¥–∞–Ω–∏–π.");
        }
    }

    window.onload = async () => {
        await loadExamInfo(examId);
        await loadTasks();
    };
</script>

</body>
</html>
